<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF認証システム v1.44</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { opacity: 0; transition: opacity 0.3s; margin: 0; background: #f0f2f5; }
        .loaded { opacity: 1; }
        .unread-item { padding:15px; border-bottom:1px solid #ddd; background:#fff; border-radius:8px; margin-bottom:10px; text-align: left; }
        #after-login-area { display: none; margin-top: 20px; }
        #alert-list { display: none; margin-top: 15px; }
        .btn-main { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .accordion-btn { width: 100%; padding: 12px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-weight: bold; color: #555; }
        .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #ff4757; color: white; display: inline-block; margin-bottom: 5px; }
    </style>
</head>
<body id="main-body">
    <div class="container">
        <div class="form-box">
            <div id="logo-container" style="margin-bottom: 20px;"></div>
            <h2><span id="system-name">読み込み中...</span></h2>
            <p id="system-description" class="description">...</p>
            
            <div id="login-form-area">
                <input type="text" id="userId" placeholder="メールアドレス">
                <input type="password" id="password" placeholder="パスワード">
                <button class="btn-main" onclick="attemptLogin()">ログイン</button>
                <div id="errorMsg" style="color:#d93025; margin-top:10px; font-size:14px;"></div>
            </div>

            <div id="after-login-area">
                <button id="unread-summary-btn" class="accordion-btn" onclick="toggleAccordion()">
                    未確認の文書が 0 件あります ▼
                </button>
                <div id="alert-list"></div>
                <button class="btn-main" onclick="finalizeRedirect()" style="background:#2f3542; margin-top:20px;">メインサイトへ進む</button>
            </div>

            <div class="footer-links" style="margin-top:30px; font-size:13px;">
                <a href="signup.html">新規利用申請</a> | <a href="forgot-password.html">パスワードを忘れた</a>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let cachedRedirectUrl = "";
        let currentUserId = "";
        const urlParams = new URLSearchParams(window.location.search);
        const contentId = urlParams.get('contentId');

        window.onload = initUI;

        async function initUI() {
            const response = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_ui_config", apiKey: API_KEY, contentId: contentId })});
            const res = await response.json();
            if (res.success) {
                document.getElementById('system-name').innerText = res.title;
                document.getElementById('system-description').innerText = res.description;
            }
            document.body.classList.add('loaded');
        }

        async function attemptLogin() {
            const id = document.getElementById('userId').value;
            const pw = document.getElementById('password').value;
            if (!id || !pw) return;
            currentUserId = id;

            const response = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "login", apiKey: API_KEY, userId: id, password: pw, contentId: contentId })
            });
            const res = await response.json();

            if (res.success) {
                cachedRedirectUrl = res.redirectUrl;
                document.getElementById('login-form-area').style.display = "none";
                document.getElementById('after-login-area').style.display = "block";
                
                // 指摘①の修正: ディスクリプションを既読完了メッセージに差し替え
                if (res.processedMessage) {
                    document.getElementById('system-description').innerHTML = `<span style="color:#28a745; font-weight:bold;">✅ ${res.processedMessage}</span>`;
                }
                loadUnreadList(id);
            } else {
                document.getElementById('errorMsg').innerText = res.message;
            }
        }

        async function loadUnreadList(userId) {
            const response = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_unread_list", apiKey: API_KEY, userId: userId })});
            const d = await response.json();
            if (d.success) {
                // 指認④の修正: 件数ラベルの動的更新
                document.getElementById('unread-summary-btn').innerText = `未確認の文書が ${d.unread.length} 件あります ▼`;
                renderAlertList(d.unread);
            }
        }

        function renderAlertList(list) {
            const container = document.getElementById('alert-list');
            container.innerHTML = list.map(item => `
                <div class="unread-item">
                    <span class="status-badge">未読</span>
                    <div style="font-weight:bold;">${item.title}</div>
                    <button onclick="confirmContent('${item.id}', '${item.url}')" style="width:100%; margin-top:8px; padding:8px; cursor:pointer; background:#f8f9fa; border:1px solid #ddd; border-radius:4px;">内容を表示して確認</button>
                </div>
            `).join('');
        }

        async function confirmContent(id, url) {
            window.open(url, '_blank');
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "mark_as_read", apiKey: API_KEY, userId: currentUserId, contentId: id })
            });
            // 指摘④の解決: 処理後にリストを再取得して件数を減らす
            loadUnreadList(currentUserId);
        }

        function toggleAccordion() {
            const list = document.getElementById('alert-list');
            list.style.display = (list.style.display === "none" || list.style.display === "") ? "block" : "none";
        }

        function finalizeRedirect() { if (cachedRedirectUrl) window.location.href = cachedRedirectUrl; }
    </script>
</body>
</html>