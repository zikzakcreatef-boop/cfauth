<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF認証システム v1.41</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { opacity: 0; transition: opacity 0.3s; margin: 0; }
        .loaded { opacity: 1; }
        .unread-item { padding:12px 15px; border-bottom:1px solid #ddd; background:#fff; border-radius:8px; margin-bottom:10px; text-align: left; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #after-login-area { display: none; margin-top: 20px; border-top: 2px dashed #eee; padding-top: 20px; }
        #alert-list { margin-top: 15px; }
        .btn-main { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-check { width: 100%; margin-top: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 13px; }
    </style>
</head>
<body id="main-body">
    <div class="container">
        <div class="form-box">
            <div id="logo-container" style="margin-bottom: 20px;"></div>
            <h2><span id="system-name">読み込み中...</span></h2>
            <p class="description">...</p>
            
            <div id="login-form-area">
                <input type="text" id="userId" placeholder="メールアドレス">
                <input type="password" id="password" placeholder="パスワード">
                <button class="btn-main" id="loginBtn" onclick="attemptLogin()">ログイン</button>
                <div id="errorMsg" style="color:#d93025; margin-top:10px; font-size:14px;"></div>
            </div>

            <div id="after-login-area">
                <div style="font-weight:bold; color:#d93025; margin-bottom:10px;">未確認の重要文書があります</div>
                <div id="alert-list"></div>
                <button class="btn-main" id="goMainBtn" onclick="finalizeRedirect()" style="background:#28a745; margin-top:20px;">すべて確認してメインサイトへ</button>
            </div>

            <div class="footer-links" style="margin-top:30px; font-size:13px;">
                <a href="signup.html">新規利用申請</a> | <a href="forgot-password.html">パスワードを忘れた</a>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let cachedRedirectUrl = "";
        const urlParams = new URLSearchParams(window.location.search);
        const contentId = urlParams.get('contentId'); // contentIdを正とする

        window.onload = function() {
            initUI();
        };

        async function initUI() {
            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_ui_config", apiKey: API_KEY, contentId: contentId })
                });
                const res = await response.json();
                if (res.success) {
                    document.getElementById('system-name').innerText = res.title;
                    const descElem = document.querySelector('.description');
                    if (descElem) descElem.innerText = res.description;
                    document.body.style.backgroundColor = res.bg || "#f0f2f5";
                    if (res.logo && res.logo !== 'none') {
                        document.getElementById('logo-container').innerHTML = `<img src="${res.logo}" style="max-width:120px;">`;
                    }
                }
            } catch (e) { console.error("Init Error:", e); }
            document.body.classList.add('loaded');
        }

        async function attemptLogin() {
            const id = document.getElementById('userId').value;
            const pw = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('errorMsg');

            if (!id || !pw) { err.innerText = "IDとパスワードを入力してください。"; return; }

            btn.disabled = true;
            btn.innerText = "認証中...";

            try {
                // GAS側でログインと同時にcontentIdの既読化も行う
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "login", apiKey: API_KEY, userId: id, password: pw, contentId: contentId })
                });
                const res = await response.json();

                if (res.success) {
                    cachedRedirectUrl = res.redirectUrl;
                    checkUnreadAndFlow(id); 
                } else {
                    err.innerText = res.message;
                    btn.disabled = false;
                    btn.innerText = "ログイン";
                }
            } catch (e) { err.innerText = "通信エラー"; btn.disabled = false; }
        }

        async function checkUnreadAndFlow(userId) {
            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_unread_list", apiKey: API_KEY, userId: userId })
                });
                const d = await response.json();

                // 未読がある場合のみリストを表示。なければ即遷移。
                if (d.success && d.unread.length > 0) {
                    document.getElementById('login-form-area').style.display = "none";
                    document.getElementById('after-login-area').style.display = "block";
                    renderAlertList(d.unread);
                } else {
                    finalizeRedirect();
                }
            } catch (e) { finalizeRedirect(); }
        }

        function renderAlertList(list) {
            const container = document.getElementById('alert-list');
            container.innerHTML = list.map(item => `
                <div class="unread-item">
                    <div style="font-size:11px; color:#999;">未読</div>
                    <div style="font-weight:bold; margin:4px 0;">${item.title}</div>
                    <button class="btn-check" onclick="window.open('${item.url}', '_blank')">内容を表示して確認</button>
                </div>
            `).join('');
        }

        function finalizeRedirect() {
            if (cachedRedirectUrl) window.location.href = cachedRedirectUrl;
        }
    </script>
</body>
</html>