<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF認証システム</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { opacity: 0; transition: opacity 0.3s; }
        .loaded { opacity: 1; }
        #alert-list { display: none; text-align: left; margin: 15px 0; max-height: 250px; overflow-y: auto; border-top: 1px solid #eee; padding-top: 10px; }
        .unread-badge { display: inline-block; background: #f8d7da; color: #721c24; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-left: 5px; }
        .system-desc { font-size: 14px; color: #666; margin-bottom: 24px; line-height: 1.6; white-space: pre-wrap; }
    </style>
</head>
<body id="main-body">
    <div class="container">
        <div class="form-box">
            <div id="logo-container" style="margin-bottom: 20px;"></div>
            <h2 id="system-title">Loading...</h2>
            <div id="system-description" class="system-desc"></div>

            <div id="login-form">
                <div class="input-group">
                    <input type="email" id="userId" placeholder="メールアドレス" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="パスワード" required>
                </div>
                <button class="btn btn-primary" onclick="login()">ログイン</button>
                <div class="footer-links" style="margin-top: 20px;">
                    <a href="signup.html">新規登録はこちら</a><br><br>
                    <a href="forgot-password.html">パスワードを忘れた方</a>
                </div>
            </div>

            <div id="user-panel" style="display:none;">
                <p class="description">こんにちは、<span id="display-name" style="font-weight:bold;"></span> さん</p>
                <div id="unread-info" style="margin-bottom: 15px; font-size: 14px;">未読のお知らせ: <span id="unread-count" class="unread-badge">0</span></div>
                <div id="alert-list"></div>
                <button id="entry-btn" class="btn btn-success" style="width:100%; margin-top:10px;">閲覧サイトへ移動</button>
                <button class="btn btn-secondary" onclick="logout()" style="width:100%; margin-top:10px; background:#6c757d;">ログアウト</button>
            </div>
            <p id="message" class="status-message"></p>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let loggedInUserId = "";
        let clickedIds = new Set();
        let redirectUrl = "";

        // 起動時に全データを揃えて反映
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const contentId = urlParams.get('id');
            
            try {
                // 標準設定とコンテンツ情報の取得を並列化
                const requests = [
                    fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_ui_config", apiKey: API_KEY }) }).then(r => r.json())
                ];
                if (contentId) {
                    requests.push(fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_content_info", apiKey: API_KEY, contentId: contentId }) }).then(r => r.json()));
                }

                const results = await Promise.all(requests);
                const configRes = results[0];
                const contentRes = contentId ? results[1] : null;

                if (configRes.success) {
                    const config = configRes.data;
                    document.body.style.setProperty('background', config.bg_color, 'important');
                    if (config.logo_url && config.logo_url !== "none") {
                        document.getElementById('logo-container').innerHTML = `<img src="${config.logo_url}" style="max-width: 120px; height: auto;">`;
                    }

                    // タイトル・説明文の決定（ID指名を最優先）
                    if (contentRes && contentRes.success) {
                        document.getElementById('system-title').innerText = contentRes.data.title;
                        document.getElementById('system-description').innerText = contentRes.data.description;
                    } else {
                        document.getElementById('system-title').innerText = config.system_title;
                        document.getElementById('system-description').innerText = config.system_description || "";
                    }
                    localStorage.setItem('cached_system_title', config.system_title);
                }
            } catch (e) {
                console.error("Init error", e);
            } finally {
                document.body.classList.add('loaded');
            }
        };

        async function login() {
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('message');
            if (!userId || !password) { msg.innerText = "IDとパスワードを入力してください。"; return; }

            try {
                const response = await fetch(GAS_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ action: "login", apiKey: API_KEY, userId, password }) 
                });
                const res = await response.json();
                
                if (res.success) {
                    loggedInUserId = userId;
                    redirectUrl = res.data.redirectUrl;
                    document.getElementById('login-form').style.display = "none";
                    document.getElementById('system-description').style.display = "none";
                    document.getElementById('user-panel').style.display = "block";
                    document.getElementById('display-name').innerText = res.data.userName;
                    renderUnreadList(res.data.unreadList);
                    document.getElementById('entry-btn').onclick = () => { window.location.href = redirectUrl; };
                } else {
                    msg.style.color = "#d93025";
                    msg.innerText = res.message;
                }
            } catch (error) { msg.innerText = "通信エラーが発生しました。"; }
        }

        function renderUnreadList(list) {
            const listDiv = document.getElementById('alert-list');
            const countSpan = document.getElementById('unread-count');
            listDiv.innerHTML = "";
            if (!list || list.length === 0) { listDiv.style.display = "none"; countSpan.innerText = "0"; return; }
            listDiv.style.display = "block";
            countSpan.innerText = list.length;
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.id = `item-${index}`;
                div.style.cssText = "padding:12px; border-bottom:1px solid #eee; margin-bottom:8px; background:#fafafa; border-radius:6px; font-size:14px;";
                div.innerHTML = `
                    <div style="font-weight:bold;"><span id="status-icon-${index}">⭕</span> ${item.title}</div>
                    <div style="color:#007bff; font-size:12px; cursor:pointer; text-decoration:underline; margin-top:5px;" 
                         onclick="handleLinkClick(event, '${item.url}', '${index}', '${item.id}')">▶ 内容を確認する</div>
                `;
                listDiv.appendChild(div);
            });
        }

        async function handleLinkClick(event, url, index, id) {
            if(event) event.preventDefault();
            window.open(url, '_blank');
            if (clickedIds.has(id)) return;
            // 既読記録（昨日実装したロジックの呼び出し）
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "record_read", apiKey: API_KEY, userId: loggedInUserId, contentId: id }) });
            clickedIds.add(id);
            document.getElementById(`item-${index}`).style.backgroundColor = "#f0fdf4";
            document.getElementById(`status-icon-${index}`).innerText = "✅";
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>