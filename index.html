<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF認証システム1.26</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { opacity: 0; transition: opacity 0.3s; margin: 0; }
        .loaded { opacity: 1; }
        .unread-item { padding:12px 15px; border-bottom:1px solid #ddd; background:#fff; border-radius:8px; margin-bottom:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #unread-list { margin-top: 20px; text-align: left; }
        .welcome-msg { margin-bottom: 20px; font-weight: bold; font-size: 1.1em; color: #333; }
        .btn-main { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn-main:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body id="main-body">
    <div id="loading-screen">読み込み中...</div>

    <div class="container" id="login-area" style="display:none;">
        <div class="form-box">
            <h2 id="display-title">ログイン</h2>
            <p id="display-desc"></p>
            <input type="email" id="userId" placeholder="メールアドレス" required>
            <input type="password" id="password" placeholder="パスワード" required>
            <button class="btn btn-primary" id="loginBtn" onclick="handleLogin()">ログイン</button>
            <p id="errorMsg" style="color:red; margin-top:10px;"></p>
            <div class="footer-links">
                <a href="signup.html">新規利用申請</a> | <a href="forgot-password.html">パスワードを忘れた</a>
            </div>
        </div>
    </div>

    <div class="container" id="content-area" style="display:none;">
        <div class="form-box">
            <div class="welcome-msg" id="welcome-user"></div>
            <p>以下の未読コンテンツを確認してください。</p>
            <div id="unread-list"></div>
            <hr>
            <button id="goMainBtn" class="btn-main" onclick="goToMain()">メインサイトへ進む</button>
            <button class="btn btn-secondary" style="margin-top:10px;" onclick="handleLogout()">ログアウト</button>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let loggedInUserId = "";
        let finalRedirectUrl = "";

        // 1.11準拠のUI設定取得
        window.onload = async function() {
            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_ui_config", apiKey: API_KEY })
                });
                const res = await response.json();
                if (res.success) {
                    // res.data.title ではなく res.title (1.11形式)
                    document.getElementById('display-title').innerText = res.title || "ログイン";
                    document.getElementById('display-desc').innerText = res.description || "";
                    if (res.bgColor) document.body.style.backgroundColor = res.bgColor;
                }
            } catch (e) {
                console.error("Config Load Error:", e);
            } finally {
                document.getElementById('login-area').style.display = 'block';
                document.getElementById('loading-screen').style.display = 'none';
                document.body.classList.add('loaded');
            }
        };

        // 1.11準拠のログイン処理
        async function handleLogin() {
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('errorMsg');

            if (!userId || !password) {
                errorMsg.innerText = "IDとパスワードを入力してください。";
                return;
            }

            btn.disabled = true;
            btn.innerText = "認証中...";
            errorMsg.innerText = "";

            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "login", apiKey: API_KEY, userId, password })
                });
                const res = await response.json();

                if (res.success) {
                    loggedInUserId = userId;
                    // res.data.xxx ではなく res.xxx (1.11形式)
                    finalRedirectUrl = res.redirectUrl;
                    renderContentArea(res.userName, res.unreadAlerts);
                } else {
                    errorMsg.innerText = res.message;
                    btn.disabled = false;
                    btn.innerText = "ログイン";
                }
            } catch (e) {
                errorMsg.innerText = "通信エラーが発生しました。";
                btn.disabled = false;
                btn.innerText = "ログイン";
            }
        }

        function renderContentArea(userName, unreadList) {
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('content-area').style.display = 'block';
            document.getElementById('welcome-user').innerText = `こんにちは、${userName} 様`;
            
            const listDiv = document.getElementById('unread-list');
            listDiv.innerHTML = "";

            if (!unreadList || unreadList.length === 0) {
                listDiv.innerHTML = "<p>未読の重要なお知らせはありません。</p>";
                document.getElementById('goMainBtn').disabled = false;
                document.getElementById('goMainBtn').innerText = "メインサイトへ進む";
            } else {
                unreadList.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'unread-item';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="text-align:left;">
                                <strong>${item.title}</strong><br>
                                <small style="color:#666;">${item.description}</small>
                            </div>
                            <button class="btn btn-sm" onclick="openContent('${item.url}', '${item.id}')">閲覧する</button>
                        </div>
                    `;
                    listDiv.appendChild(div);
                });
                document.getElementById('goMainBtn').disabled = true;
                document.getElementById('goMainBtn').innerText = "未読を確認してください";
            }
        }

        async function openContent(url, id) {
            try {
                await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "record_read", apiKey: API_KEY, userId: loggedInUserId, contentId: id })
                });
                window.open(url, '_blank');
                alert("閲覧を記録しました。");
                location.reload(); 
            } catch (e) {
                console.error(e);
            }
        }

        function goToMain() {
            window.location.href = finalRedirectUrl || "https://www.yahoo.co.jp/";
        }

        function handleLogout() {
            localStorage.clear();
            location.reload();
        }
    </script>
</body>
</html>