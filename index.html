<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF認証システム1.20</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { opacity: 0; transition: opacity 0.3s; margin: 0; }
        .loaded { opacity: 1; }
        .unread-item { padding:12px 15px; border-bottom:1px solid #ddd; background:#fff; border-radius:8px; margin-bottom:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #unread-list { margin-top: 20px; }
    </style>
</head>
<body id="main-body">
    <div id="loading-screen">読み込み中...</div>

    <div class="container" id="login-area" style="display:none;">
        <div class="form-box">
            <h2 id="display-title">ログイン</h2>
            <p id="display-desc"></p>
            <input type="email" id="userId" placeholder="メールアドレス">
            <input type="password" id="password" placeholder="パスワード">
            <button class="btn btn-primary" onclick="handleLogin()">ログイン</button>
            <div class="footer-links">
                <a href="signup.html">新規利用申請</a> | <a href="forgot-password.html">パスワードを忘れた</a>
            </div>
        </div>
    </div>

    <div class="container" id="content-area" style="display:none;">
        <h3>こんにちは、<span id="user-name-disp"></span>さん</h3>
        <p>未読のコンテンツがあります：</p>
        <div id="unread-list"></div>
        <button class="btn" style="margin-top:20px;" onclick="handleLogout()">ログアウト</button>
    </div>

    <script src="config.js"></script>
    <script>
        let loggedInUserId = localStorage.getItem('loggedInUserId');

        window.onload = async function() {
            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_ui_config", apiKey: API_KEY })
                });
                const config = await response.json();
                document.getElementById('display-title').innerText = config.system_title;
                document.getElementById('display-desc').innerText = config.system_description;
                document.body.style.backgroundColor = config.bg_color;
                
                if (loggedInUserId) {
                    showContents();
                } else {
                    document.getElementById('login-area').style.display = 'block';
                    document.getElementById('loading-screen').style.display = 'none';
                    document.body.classList.add('loaded');
                }
            } catch (e) {
                console.error("Initialization Error:", e);
                document.getElementById('loading-screen').innerText = "接続エラーが発生しました。";
            }
        };

        async function handleLogin() {
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const screen = document.getElementById('loading-screen');

            if(!userId || !password) { alert("入力してください"); return; }
            screen.style.display = 'flex';

            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "login", apiKey: API_KEY, userId, password })
                });
                const res = await response.json();
                if (res.success) {
                    localStorage.setItem('loggedInUserId', userId);
                    localStorage.setItem('userName', res.userName);
                    window.location.href = res.redirectUrl;
                } else {
                    alert(res.message);
                    screen.style.display = 'none';
                }
            } catch (e) {
                alert("通信エラー");
                screen.style.display = 'none';
            }
        }

        async function showContents() {
            const userName = localStorage.getItem('userName');
            document.getElementById('user-name-disp').innerText = userName;
            document.getElementById('content-area').style.display = 'block';
            document.getElementById('loading-screen').style.display = 'none';
            document.body.classList.add('loaded');
            
            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_unread", apiKey: API_KEY, userId: loggedInUserId })
                });
                const data = await response.json();
                const listDiv = document.getElementById('unread-list');
                listDiv.innerHTML = "";

                if (!data.contents || data.contents.length === 0) {
                    listDiv.innerHTML = "<p>未読はありません。最新の状態です。</p>";
                } else {
                    data.contents.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'unread-item';
                        div.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span><strong>${item.title}</strong></span>
                                <button class="btn btn-sm" onclick="openContent('${item.url}', '${item.id}')">閲覧する</button>
                            </div>
                        `;
                        listDiv.appendChild(div);
                    });
                }
            } catch (e) {
                console.error("Fetch Content Error:", e);
            }
        }

        async function openContent(url, id) {
            try {
                await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "record_read", apiKey: API_KEY, userId: loggedInUserId, contentId: id })
                });
                window.open(url, '_blank');
                location.reload();
            } catch (e) {
                console.error(e);
            }
        }

        function handleLogout() {
            localStorage.clear();
            location.reload();
        }
    </script>
</body>
</html>