<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF認証システム1.22</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { opacity: 0; transition: opacity 0.3s; margin: 0; }
        .loaded { opacity: 1; }
        .unread-item { padding:12px 15px; border-bottom:1px solid #ddd; background:#fff; border-radius:8px; margin-bottom:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #unread-list { margin-top: 20px; }
    </style>
</head>
<body id="main-body">
    <div id="loading-screen">読み込み中...</div>

    <div class="container" id="login-area" style="display:none;">
        <div class="form-box">
            <h2 id="display-title">ログイン</h2>
            <p id="display-desc"></p>
            <input type="email" id="userId" placeholder="メールアドレス">
            <input type="password" id="password" placeholder="パスワード">
            <button class="btn" onclick="handleLogin()">ログイン</button>
            <p id="login-msg" style="color:#d93025; margin-top:10px;"></p>
            <div class="footer-links">
                <a href="signup.html">新規利用申請</a> | <a href="forgot_password.html">パスワードを忘れた方</a>
            </div>
        </div>
    </div>

    <div class="container" id="main-area" style="display:none;">
        <div class="form-box" style="max-width:600px;">
            <h2>こんにちは、<span id="user-name-display"></span> さん</h2>
            <p>未読のコンテンツがあります。確認してください。</p>
            
            <div id="unread-list"></div>

            <button class="btn btn-secondary" style="margin-top:20px;" onclick="handleLogout()">ログアウト</button>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbz_7O2M-jH_3X88W8iM6Qh8-e7lI5_X9X0rWvD6p-z0_H_D_9X_/exec';
        const API_KEY = 'Z2VtX21heF8yMDI2X3NlY3VyZQ==';
        let loggedInUserId = localStorage.getItem('loggedInUserId');

        window.onload = async () => {
            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_ui_config", apiKey: API_KEY })
                });
                const config = await response.json();
                if (config.success) {
                    document.getElementById('display-title').innerText = config.system_title;
                    document.getElementById('display-desc').innerText = config.system_description;
                    document.body.style.backgroundColor = config.bg_color;
                }
            } catch (e) { console.error(e); }

            if (loggedInUserId) {
                showMainArea();
            } else {
                document.getElementById('login-area').style.display = 'block';
                document.getElementById('loading-screen').style.display = 'none';
                document.body.classList.add('loaded');
            }
        };

        async function handleLogin() {
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('login-msg');

            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "login", apiKey: API_KEY, userId: userId, password: password })
                });
                const res = await response.json();

                if (res.success) {
                    localStorage.setItem('loggedInUserId', userId);
                    localStorage.setItem('userName', res.userName);
                    localStorage.setItem('redirectUrl', res.redirectUrl);
                    loggedInUserId = userId;
                    showMainArea();
                } else {
                    msg.innerText = res.message;
                }
            } catch (e) {
                msg.innerText = "通信エラーが発生しました。";
            }
        }

        function showMainArea() {
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('main-area').style.display = 'block';
            document.getElementById('user-name-display').innerText = localStorage.getItem('userName');
            document.getElementById('loading-screen').style.display = 'none';
            document.body.classList.add('loaded');
            showContents();
        }

        async function showContents() {
            const listDiv = document.getElementById('unread-list');
            listDiv.innerHTML = "読み込み中...";

            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_unread", apiKey: API_KEY, userId: loggedInUserId })
                });
                const data = await response.json();

                listDiv.innerHTML = "";
                if (!data.contents || data.contents.length === 0) {
                    const redirectUrl = localStorage.getItem('redirectUrl');
                    window.location.href = redirectUrl || "https://www.yahoo.co.jp/";
                } else {
                    data.contents.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'unread-item';
                        div.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span><strong>${item.title}</strong></span>
                                <button class="btn btn-sm" onclick="openContent('${item.url}', '${item.id}')">閲覧する</button>
                            </div>
                        `;
                        listDiv.appendChild(div);
                    });
                }
            } catch (e) {
                console.error("Fetch Content Error:", e);
                listDiv.innerHTML = "エラーが発生しました。";
            }
        }

        async function openContent(url, id) {
            try {
                await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "record_read", apiKey: API_KEY, userId: loggedInUserId, contentId: id })
                });
                window.open(url, '_blank');
                location.reload();
            } catch (e) {
                console.error(e);
            }
        }

        function handleLogout() {
            localStorage.clear();
            location.reload();
        }
    </script>
</body>
</html>