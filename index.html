<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF認証システム</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #alert-list {
            display: none;
            text-align: left;
            margin: 15px 0;
            max-height: 250px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .unread-badge {
            display: inline-block;
            background: #f8d7da;
            color: #721c24;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
            transition: all 0.3s ease;
        }
        .system-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 24px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
    </style>
</head>
<body id="main-body" style="transition: background 0.5s ease;">
    <div class="container">
        <div class="form-box">
            <div id="logo-container" style="margin-bottom: 20px;"></div>
            <h2 id="system-title" style="margin-bottom: 8px;">Loading...</h2>
            <div id="system-description" class="system-desc"></div>

            <div id="login-form">
                <div class="input-group">
                    <input type="email" id="userId" placeholder="メールアドレス" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="パスワード" required>
                </div>
                <button class="btn btn-primary" onclick="login()">ログイン</button>
                
                <div class="footer-links" style="margin-top: 20px;">
                    <a href="signup.html">新規登録はこちら</a><br><br>
                    <a href="forgot-password.html">パスワードを忘れた方</a>
                </div>
            </div>

            <div id="user-panel" style="display:none;">
                <p class="description">こんにちは、<span id="display-name" style="font-weight:bold;"></span> さん</p>
                <div id="unread-info" style="margin-bottom: 15px; font-size: 14px;">
                    未読のお知らせ: <span id="unread-count" class="unread-badge">0</span>
                </div>
                <div id="alert-list"></div>
                <button id="entry-btn" class="btn btn-success" style="width:100%; margin-top:10px;">
                    閲覧サイトへ移動
                </button>
                <button class="btn btn-secondary" onclick="logout()" style="width:100%; margin-top:10px; background:#6c757d;">
                    ログアウト
                </button>
            </div>

            <p id="message" class="status-message"></p>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let loggedInUserId = "";
        let clickedIds = new Set();
        let redirectUrl = "";

        window.onload = async function() {
            // 起動時に最優先でUIを構築する
            await initUI();
        };

        async function initUI() {
            const urlParams = new URLSearchParams(window.location.search);
            const contentId = urlParams.get('id');

            // 1. キャッシュの即時反映（ID指定がない時だけタイトルを表示）
            const cachedBg = localStorage.getItem('cached_bg_color');
            const cachedLogo = localStorage.getItem('cached_logo_url');
            if(cachedBg) document.body.style.setProperty('background', cachedBg, 'important');
            if(cachedLogo && cachedLogo !== "none") {
                document.getElementById('logo-container').innerHTML = `<img src="${cachedLogo}" style="max-width: 120px; height: auto;">`;
            }

            try {
                // 2. GASから基本設定（config）とコンテンツ情報（id指定時）を同時に取得
                // 複数のリクエストを並行実行して、最終的な表示を決定する
                const configPromise = fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_ui_config", apiKey: API_KEY })
                }).then(r => r.json());

                let contentPromise = Promise.resolve({ success: false });
                if (contentId) {
                    contentPromise = fetch(GAS_URL, {
                        method: "POST",
                        body: JSON.stringify({ action: "get_content_info", apiKey: API_KEY, contentId: contentId })
                    }).then(r => r.json());
                }

                const [configRes, contentRes] = await Promise.all([configPromise, contentPromise]);

                // 3. 基本UI（背景・ロゴ）の反映
                if (configRes.success) {
                    const config = configRes.data;
                    document.body.style.setProperty('background', config.bg_color, 'important');
                    if (config.logo_url && config.logo_url !== "none") {
                        document.getElementById('logo-container').innerHTML = `<img src="${config.logo_url}" style="max-width: 120px; height: auto;">`;
                    }
                    localStorage.setItem('cached_bg_color', config.bg_color);
                    localStorage.setItem('cached_logo_url', config.logo_url);
                    localStorage.setItem('cached_system_title', config.system_title);

                    // 4. 【核心】タイトルと説明文の確定
                    // コンテンツ指名(contentRes)が成功していればそれを使い、そうでなければ標準configを使う
                    if (contentRes.success) {
                        document.getElementById('system-title').innerText = contentRes.data.title;
                        document.getElementById('system-description').innerText = contentRes.data.description;
                    } else {
                        document.getElementById('system-title').innerText = config.system_title;
                        document.getElementById('system-description').innerText = config.system_description || "";
                    }
                }
            } catch (e) {
                console.error("UI Init Error:", e);
                document.getElementById('system-title').innerText = "CF認証システム";
            }
        }

        async function login() {
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('message');
            
            if (!userId || !password) {
                msg.innerText = "IDとパスワードを入力してください。";
                return;
            }

            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "login", apiKey: API_KEY, userId, password })
                });
                const res = await response.json();

                if (res.success) {
                    loggedInUserId = userId;
                    redirectUrl = res.data.redirectUrl;
                    document.getElementById('login-form').style.display = "none";
                    document.getElementById('system-description').style.display = "none"; // ログイン後は説明を隠す
                    document.getElementById('user-panel').style.display = "block";
                    document.getElementById('display-name').innerText = res.data.userName;
                    msg.innerText = "";
                    renderUnreadList(res.data.unreadList);
                    document.getElementById('entry-btn').onclick = () => { window.location.href = redirectUrl; };
                } else {
                    msg.style.color = "#d93025";
                    msg.innerText = res.message;
                }
            } catch (error) { msg.innerText = "通信エラーが発生しました。"; }
        }

        function renderUnreadList(list) {
            const listDiv = document.getElementById('alert-list');
            const countSpan = document.getElementById('unread-count');
            listDiv.innerHTML = "";
            if (!list || list.length === 0) { listDiv.style.display = "none"; countSpan.innerText = "0"; return; }
            listDiv.style.display = "block";
            countSpan.innerText = list.length;
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.id = `item-${index}`;
                div.style.cssText = "padding:12px; border-bottom:1px solid #eee; margin-bottom:8px; background:#fafafa; border-radius:6px; font-size:14px;";
                div.innerHTML = `
                    <div style="font-weight:bold;"><span id="status-icon-${index}">⭕</span> ${item.title}</div>
                    <div style="color:#007bff; font-size:12px; cursor:pointer; text-decoration:underline; margin-top:5px;" 
                         onclick="handleLinkClick(event, '${item.url}', '${index}', '${item.id}')">
                       ▶ 内容を確認する
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        async function handleLinkClick(event, url, index, id) {
            if(event) event.preventDefault();
            window.open(url, '_blank');
            if (clickedIds.has(id)) return;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "record_read", apiKey: API_KEY, userId: loggedInUserId, contentId: id }) });
            clickedIds.add(id);
            document.getElementById(`item-${index}`).style.backgroundColor = "#f0fdf4";
            document.getElementById(`status-icon-${index}`).innerText = "✅";
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>