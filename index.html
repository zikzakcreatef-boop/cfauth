<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF認証システム - ログイン</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="login-card">
    <h2>CF認証システム</h2>
    <input type="email" id="userId" placeholder="メールアドレス" required>
    <input type="password" id="password" placeholder="パスワード" required>
    <button id="loginBtn" onclick="login()">ログイン</button>
    <div id="message"></div>

    <div class="nav-links">
        <a href="signup.html">新規利用の申請</a> | 
        <a href="forgot-password.html">パスワードを忘れた</a>
    </div>
</div>

<script>
    // GASのURL（デプロイした最新のURL）
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzGnpuZTVPIi3alkZF7kxq0r99Zi3-sqZ8LM0pY-xmBaXJSAAwcUKYwHDNhJNb-YOWU3A/exec";
    // ログイン成功後の遷移先
    const REDIRECT_URL = "https://www.notion.so/2c79609a7be68066befecbbfefbdd470";

    /**
     * 通常のログイン処理
     */
    async function login() {
        const userId = document.getElementById('userId').value;
        const password = document.getElementById('password').value;
        const btn = document.getElementById('loginBtn');
        const msg = document.getElementById('message');

        if (!userId || !password) {
            msg.innerText = "メールアドレスとパスワードを入力してください";
            msg.className = "error";
            return;
        }

        btn.disabled = true;
        msg.innerText = "認証中...";
        msg.className = "";

        try {
            const response = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "login",
                    userId: userId,
                    password: password
                })
            });

            const result = await response.json();

            if (result.success) {
                msg.innerText = "認証成功！移動します...";
                msg.className = "success";
                setTimeout(() => {
                    window.location.href = `${REDIRECT_URL}?token=${result.token}`;
                }, 800);
            } else {
                msg.innerText = result.message;
                msg.className = "error";
                btn.disabled = false;
            }
        } catch (error) {
            msg.innerText = "通信エラーが発生しました";
            msg.className = "error";
            btn.disabled = false;
        }
    }

    /**
     * パスワードリセットのモーダル（入力）処理
     */
    async function openResetModal() {
        const email = prompt("登録済みのメールアドレスを入力してください。\nパスワード再設定用のメールを送信します。");
        
        // キャンセルされた場合や空欄の場合は何もしない
        if (email === null || email.trim() === "") return;

        const msg = document.getElementById('message');
        msg.innerText = "アドレス確認中...";
        msg.className = "";

        try {
            const response = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "request_reset",
                    email: email.trim()
                })
            });
            const result = await response.json();

            if (result.success) {
                msg.innerText = "リセットメールを送信しました。";
                msg.className = "success";
                alert("指定のアドレスにメールを送信しました！\n届いたリンクからパスワードを再設定してください。");
            } else {
                // ここで「登録されていないアドレス」なら弾かれる
                msg.innerText = result.message;
                msg.className = "error";
                alert("エラー: " + result.message);
            }
        } catch (error) {
            msg.innerText = "通信エラーが発生しました";
            msg.className = "error";
            alert("通信エラーが発生しました。ネット環境を確認してください。");
        }
    }
</script>
 
</body>
</html>