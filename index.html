<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF認証システム</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #alert-list {
            display: none;
            text-align: left;
            margin: 15px 0;
            max-height: 250px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .unread-badge {
            display: inline-block;
            background: #f8d7da;
            color: #721c24;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body id="main-body" style="transition: background 0.5s ease;">
    <div class="container">
        <div class="form-box">
            <div id="logo-container" style="margin-bottom: 20px;"></div>
            <h2 id="system-title">Loading...</h2>

            <div id="login-form">
                <div class="input-group"><input type="email" id="userId" placeholder="メールアドレス" required></div>
                <div class="input-group"><input type="password" id="password" placeholder="パスワード" required></div>
                <button class="btn btn-primary" onclick="login()">ログイン</button>
                <div class="footer-links" style="margin-top: 20px;">
                    <a href="signup.html">新規登録はこちら</a><br><br>
                    <a href="forgot-password.html">パスワードを忘れた方</a>
                </div>
            </div>

            <div id="user-panel" style="display:none;">
                <p class="description">こんにちは、<span id="display-name" style="font-weight:bold;"></span> さん</p>
                
                <div id="unread-info" style="margin-bottom: 15px; font-size: 14px;">
                    未読のお知らせ: <span id="unread-count" class="unread-badge">0</span>
                </div>

                <div id="alert-list"></div>

                <button id="entry-btn" class="btn btn-success" style="width:100%; margin-top:10px;">閲覧サイトへ移動</button>
                <button class="btn btn-secondary" onclick="logout()" style="width:100%; margin-top:10px; background:#6c757d;">ログアウト</button>
            </div>

            <p id="message" class="status-message"></p>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let loggedInUserId = "";
        let clickedIds = new Set();
        let redirectUrl = "";

        window.onload = fetchUIConfig;

        async function fetchUIConfig() {
            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "get_ui_config", apiKey: API_KEY })
                });
                const res = await response.json();
                if (res.success) {
                    const config = res.data;
                    document.getElementById('system-title').innerText = config.system_title;
                    document.body.style.setProperty('background', config.bg_color, 'important');
                    if (config.logo_url && config.logo_url !== "none") {
                        document.getElementById('logo-container').innerHTML = `<img src="${config.logo_url}" style="max-width: 120px; height: auto;">`;
                    }
                    // キャッシュ保存
                    localStorage.setItem('cached_system_title', config.system_title);
                    localStorage.setItem('cached_bg_color', config.bg_color);
                    localStorage.setItem('cached_logo_url', config.logo_url);
                }
            } catch (e) {
                document.getElementById('system-title').innerText = localStorage.getItem('cached_system_title') || "CF認証システム";
            }
        }

        async function login() {
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('message');

            try {
                const response = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "login", apiKey: API_KEY, userId, password })
                });
                const res = await response.json();

                if (res.success) {
                    loggedInUserId = userId;
                    redirectUrl = res.data.redirectUrl; // GASから返されたURL（個別優先）
                    
                    document.getElementById('login-form').style.display = "none";
                    document.getElementById('user-panel').style.display = "block";
                    document.getElementById('display-name').innerText = res.data.userName;
                    msg.innerText = "";

                    renderUnreadList(res.data.unreadList);
                    
                    // 閲覧サイト移動ボタンの挙動設定
                    document.getElementById('entry-btn').onclick = () => { window.location.href = redirectUrl; };

                } else {
                    msg.style.color = "#d93025";
                    msg.innerText = res.message;
                }
            } catch (e) {
                msg.innerText = "通信エラーが発生しました。";
            }
        }

        function renderUnreadList(list) {
            const listDiv = document.getElementById('alert-list');
            const countSpan = document.getElementById('unread-count');
            listDiv.innerHTML = "";
            
            if (!list || list.length === 0) {
                listDiv.style.display = "none";
                countSpan.innerText = "0";
                countSpan.style.background = "#e9ecef";
                countSpan.style.color = "#6c757d";
                return;
            }

            listDiv.style.display = "block";
            countSpan.innerText = list.length;

            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.id = `item-${index}`;
                div.style.cssText = "padding:12px; border-bottom:1px solid #eee; margin-bottom:8px; background:#fafafa; border-radius:6px; font-size:14px;";
                div.innerHTML = `
                    <div style="font-weight:bold;"><span id="status-icon-${index}">⭕</span> ${item.title}</div>
                    <div style="color:#007bff; font-size:12px; cursor:pointer; text-decoration:underline; margin-top:5px;" 
                         onclick="handleLinkClick(event, '${item.url}', '${index}', '${item.id}')">
                       ▶ 内容を確認する
                    </div>
                `;
                listDiv.appendChild(div);
            });
        }

        async function handleLinkClick(event, url, index, id) {
            if(event) event.preventDefault();
            window.open(url, '_blank');
            if (clickedIds.has(id)) return;

            fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "record_read", apiKey: API_KEY, userId: loggedInUserId, contentId: id })
            });

            clickedIds.add(id);
            document.getElementById(`item-${index}`).style.backgroundColor = "#f0fdf4";
            document.getElementById(`status-icon-${index}`).innerText = "✅";
        }

        function logout() {
            location.reload();
        }
    </script>
</body>
</html>